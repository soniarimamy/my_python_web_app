name: Build, Push and Deploy to Local VM (Self-Hosted Runner)

on:
  push:
    branches: [main]

jobs:
  build-push-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List files (debug)
        run: dir
        shell: cmd

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:latest .
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:latest ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:${{ github.sha }}

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:${{ github.sha }}

      - name: Deploy locally on Windows
        run: |
          Write-Host "Début du déploiement local..."
          
          $DOCKERHUB_USERNAME = "${{ secrets.DOCKERHUB_USERNAME }}"
          $IMAGE_NAME = "mon-site-flask"
          $TAG = "latest"
          # CORRECTION ICI : Utilisez ${...} pour éviter le problème avec le :
          $FULL_IMAGE = "${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${TAG}"
          $CONTAINER_NAME = "flask-app"
          
          Write-Host "Image à déployer: $FULL_IMAGE"
          
          # Pull latest image
          docker pull $FULL_IMAGE
          
          # Stop and remove old container
          docker stop $CONTAINER_NAME 2>$null
          docker rm $CONTAINER_NAME 2>$null
          
          # Run new container
          docker run -d `
            --name $CONTAINER_NAME `
            --restart unless-stopped `
            -p 5000:5000 `
            -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" `
            -e FLASK_ENV=production `
            $FULL_IMAGE
          
          # Check if container is running
          Start-Sleep -Seconds 5
          if (docker ps | Select-String $CONTAINER_NAME) {
            Write-Host "✅ Conteneur démarré avec succès"
            Write-Host "Application disponible sur http://localhost:5000"
          } else {
            Write-Host "❌ Échec du démarrage du conteneur"
            docker logs $CONTAINER_NAME
            exit 1
          }
        shell: powershell